<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Photo 2048</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont;
  background: #faf8ef;
  text-align: center;
}

.screen {
  display: none;
  padding: 20px;
}

.active {
  display: block;
}

h1 {
  margin-top: 20px;
}

button {
  padding: 12px 20px;
  margin: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: #8f7a66;
  color: white;
}

.board {
  width: 320px;
  height: 320px;
  margin: 20px auto;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  background: #bbada0;
  padding: 6px;
  border-radius: 10px;
}

.cell {
  background: #cdc1b4;
  border-radius: 6px;
  position: relative;
  overflow: hidden;
}

.cell img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  will-change: transform;
}

.num {
  position: absolute;
  bottom: 4px;
  right: 6px;
  font-size: 14px;
  color: white;
  text-shadow: 0 1px 4px rgba(0,0,0,.6);
}

.score {
  display: flex;
  justify-content: space-around;
  margin-top: 10px;
}
</style>
</head>

<body>

<!-- é¦–é¡µ -->
<div id="home" class="screen active">
  <h1>ðŸ“¸ Photo 2048</h1>
  <button onclick="startDemo()">Demo Mode</button>
  <button onclick="startCustom()">Custom Mode</button>
</div>

<!-- æ¸¸æˆ -->
<div id="game" class="screen">
  <div class="score">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <input type="file" id="upload" multiple accept="image/*">
  <div class="board" id="board"></div>
</div>

<script>
const board = document.getElementById("board");
const scoreEl = document.getElementById("score");
const bestEl = document.getElementById("best");

let grid, imagesByLevel = {}, score = 0;
bestEl.textContent = localStorage.getItem("best") || 0;

function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function startDemo() {
  imagesByLevel = {};
  for (let i = 1; i <= 12; i++) {
    imagesByLevel[i] = demoColor(i);
  }
  startGame();
}

function startCustom() {
  show("game");
}

document.getElementById("upload").addEventListener("change", async e => {
  const files = [...e.target.files];
  imagesByLevel = {};
  let lvl = 1;
  for (const file of files) {
    imagesByLevel[lvl++] = await compress(file);
  }
  startGame();
});

function startGame() {
  show("game");
  grid = Array(16).fill(null);
  score = 0;
  addTile(); addTile();
  render();
}

function compress(file) {
  return new Promise(r => {
    const img = new Image();
    img.onload = () => {
      const c = document.createElement("canvas");
      c.width = c.height = 128;
      c.getContext("2d").drawImage(img,0,0,128,128);
      r(c.toDataURL("image/jpeg",0.7));
    };
    img.src = URL.createObjectURL(file);
  });
}

function addTile() {
  const empty = grid.map((v,i)=>v?null:i).filter(v=>v!==null);
  if (!empty.length) return;
  const i = empty[Math.floor(Math.random()*empty.length)];
  grid[i] = { level:1, img: imagesByLevel[1] };
}

function slide(arr) {
  arr = arr.filter(Boolean);
  for (let i=0;i<arr.length-1;i++) {
    if (arr[i].level === arr[i+1].level) {
      arr[i].level++;
      arr[i].img = imagesByLevel[arr[i].level] || arr[i].img;
      score += 2 ** arr[i].level;
      arr[i+1] = null;
    }
  }
  return arr.filter(Boolean);
}

function move(dir) {
  let moved = false;
  const g = [...grid];
  const idx = i => dir==="L"?i:dir==="R"?3-i:dir==="U"?i*4:12-i*4;
  for (let r=0;r<4;r++) {
    let row=[];
    for (let c=0;c<4;c++) row.push(g[idx(r*4+c)]);
    let s = slide(row);
    while (s.length<4) s.push(null);
    for (let c=0;c<4;c++) {
      if (grid[idx(r*4+c)]!==s[c]) moved=true;
      grid[idx(r*4+c)] = s[c];
    }
  }
  if (moved) addTile();
  render();
}

function render() {
  board.innerHTML="";
  scoreEl.textContent=score;
  bestEl.textContent=Math.max(bestEl.textContent,score);
  localStorage.setItem("best",bestEl.textContent);
  grid.forEach(c=>{
    const d=document.createElement("div");
    d.className="cell";
    if(c){
      d.innerHTML=`<img src="${c.img}"><div class="num">${2**c.level}</div>`;
    }
    board.appendChild(d);
  });
}

let sx,sy;
document.addEventListener("touchstart",e=>{sx=e.touches[0].x;sy=e.touches[0].y});
document.addEventListener("touchend",e=>{
  let dx=e.changedTouches[0].x-sx,dy=e.changedTouches[0].y-sy;
  if(Math.abs(dx)>Math.abs(dy)) dx>30?move("R"):dx<-30&&move("L");
  else dy>30?move("D"):dy<-30&&move("U");
});

function demoColor(l){
  const c=document.createElement("canvas");
  c.width=c.height=128;
  const x=c.getContext("2d");
  x.fillStyle=`hsl(${l*25},60%,60%)`;
  x.fillRect(0,0,128,128);
  return c.toDataURL();
}
</script>
</body>
</html>
