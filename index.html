<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Photo 2048</title>
<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont;
  background: #faf8ef;
  text-align: center;
  user-select: none;
}
.screen {
  display: none;
  padding: 20px;
}
.active {
  display: block;
}
h1 {
  margin-top: 20px;
  color: #776e65;
}
button {
  padding: 12px 20px;
  margin: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  background: #8f7a66;
  color: white;
  cursor: pointer;
}
.board {
  width: 320px;
  height: 320px;
  margin: 20px auto;
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(4, 1fr);
  gap: 6px;
  background: #bbada0;
  padding: 6px;
  border-radius: 10px;
}
.cell {
  background: #cdc1b4;
  border-radius: 6px;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
.cell img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.num {
  position: absolute;
  bottom: 4px;
  right: 6px;
  font-size: 14px;
  color: white;
  text-shadow: 0 1px 4px rgba(0,0,0,.6);
  font-weight: bold;
}
.score {
  display: flex;
  justify-content: space-around;
  margin-top: 10px;
  font-size: 18px;
  color: #776e65;
}
#upload {
  margin-top: 10px;
}
</style>
</head>
<body>

<!-- È¶ñÈ°µ -->
<div id="home" class="screen active">
  <h1>üì∏ Photo 2048</h1>
  <button onclick="startDemo()">Demo Ê®°Âºè</button>
  <button onclick="startCustom()">Ëá™ÂÆö‰πâÂõæÁâá</button>
</div>

<!-- Ê∏∏Êàè -->
<div id="game" class="screen">
  <div class="score">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <input type="file" id="upload" multiple accept="image/*">
  <div class="board" id="board"></div>
</div>

<script>
const board = document.getElementById("board");
const scoreEl = document.getElementById("score");
const bestEl = document.getElementById("best");

let grid = [];
let imagesByLevel = {};
let score = 0;

bestEl.textContent = localStorage.getItem("best") || 0;

function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// ÊºîÁ§∫Ê®°Âºè
function startDemo() {
  imagesByLevel = {};
  for (let i = 1; i <= 12; i++) {
    imagesByLevel[i] = demoColor(i);
  }
  startGame();
}

// Ëá™ÂÆö‰πâÂõæÁâáÊ®°Âºè
function startCustom() {
  show("game");
}

// ‰∏ä‰º†ÂõæÁâáÂ§ÑÁêÜ
document.getElementById("upload").addEventListener("change", async e => {
  const files = [...e.target.files];
  imagesByLevel = {};
  let level = 1;
  for (const file of files) {
    if (level > 12) break;
    imagesByLevel[level] = await compressImage(file);
    level++;
  }
  startGame();
});

// ÂéãÁº©ÂõæÁâá
function compressImage(file) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = 128;
      canvas.height = 128;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, 128, 128);
      resolve(canvas.toDataURL("image/jpeg", 0.7));
    };
    img.src = URL.createObjectURL(file);
  });
}

// ÂºÄÂßãÊ∏∏Êàè
function startGame() {
  show("game");
  grid = Array(16).fill(null);
  score = 0;
  addTile();
  addTile();
  render();
}

// ÈöèÊú∫ÁîüÊàêÊñπÂùó
function addTile() {
  const emptyIndices = grid.map((v, i) => v === null ? i : null).filter(i => i !== null);
  if (emptyIndices.length === 0) return;
  const randIndex = emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
  grid[randIndex] = {
    level: 1,
    img: imagesByLevel[1]
  };
}

// ÊªëÂä®ÂêàÂπ∂Ê†∏ÂøÉ
function slideLine(cells) {
  let arr = cells.filter(x => x !== null);
  let merged = [];
  let i = 0;
  while (i < arr.length) {
    if (i + 1 < arr.length && arr[i].level === arr[i + 1].level) {
      const newLevel = arr[i].level + 1;
      merged.push({
        level: newLevel,
        img: imagesByLevel[newLevel] || arr[i].img
      });
      score += Math.pow(2, newLevel);
      i += 2;
    } else {
      merged.push(arr[i]);
      i++;
    }
  }
  while (merged.length < 4) {
    merged.push(null);
  }
  return merged;
}

// Âõõ‰∏™ÊñπÂêëÁßªÂä®
function moveLeft() {
  let moved = false;
  for (let row = 0; row < 4; row++) {
    const start = row * 4;
    const line = grid.slice(start, start + 4);
    const newLine = slideLine(line);
    for (let i = 0; i < 4; i++) {
      if (grid[start + i] !== newLine[i]) moved = true;
      grid[start + i] = newLine[i];
    }
  }
  return moved;
}
function moveRight() {
  let moved = false;
  for (let row = 0; row < 4; row++) {
    const start = row * 4;
    const line = grid.slice(start, start + 4).reverse();
    const newLine = slideLine(line).reverse();
    for (let i = 0; i < 4; i++) {
      if (grid[start + i] !== newLine[i]) moved = true;
      grid[start + i] = newLine[i];
    }
  }
  return moved;
}
function moveUp() {
  let moved = false;
  for (let col = 0; col < 4; col++) {
    const line = [grid[col], grid[col+4], grid[col+8], grid[col+12]];
    const newLine = slideLine(line);
    for (let i = 0; i < 4; i++) {
      const idx = col + i*4;
      if (grid[idx] !== newLine[i]) moved = true;
      grid[idx] = newLine[i];
    }
  }
  return moved;
}
function moveDown() {
  let moved = false;
  for (let col = 0; col < 4; col++) {
    const line = [grid[col], grid[col+4], grid[col+8], grid[col+12]].reverse();
    const newLine = slideLine(line).reverse();
    for (let i = 0; i < 4; i++) {
      const idx = col + i*4;
      if (grid[idx] !== newLine[i]) moved = true;
      grid[idx] = newLine[i];
    }
  }
  return moved;
}

// Ê∏≤ÊüìÁïåÈù¢
function render() {
  board.innerHTML = "";
  scoreEl.textContent = score;
  const best = Math.max(bestEl.textContent, score);
  bestEl.textContent = best;
  localStorage.setItem("best", best);

  grid.forEach(cell => {
    const div = document.createElement("div");
    div.className = "cell";
    if (cell) {
      div.innerHTML = `
        < img src="${cell.img}">
        <div class="num">${Math.pow(2, cell.level)}</div>
      `;
    }
    board.appendChild(div);
  });
}

// ÊâãÊú∫Ëß¶Â±èÊªëÂä®
let touchStartX = 0;
let touchStartY = 0;

document.addEventListener("touchstart", e => {
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
});

document.addEventListener("touchend", e => {
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  const threshold = 30;

  let moved = false;
  if (Math.abs(dx) > Math.abs(dy)) {
    if (dx > threshold) {
      moved = moveRight();
    } else if (dx < -threshold) {
      moved = moveLeft();
    }
  } else {
    if (dy > threshold) {
      moved = moveDown();
    } else if (dy < -threshold) {
      moved = moveUp();
    }
  }
  if (moved) {
    addTile();
    render();
  }
});

// ÊºîÁ§∫Áî®Á∫ØËâ≤Âõæ
function demoColor(level) {
  const canvas = document.createElement("canvas");
  canvas.width = 128;
  canvas.height = 128;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = `hsl(${level * 25}, 70%, 60%)`;
  ctx.fillRect(0, 0, 128, 128);
  return canvas.toDataURL();
}
</script>
</body>
</html>
